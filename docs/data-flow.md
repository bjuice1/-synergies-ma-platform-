# Data Flow Map - M&A Synergies Analysis Tool

**Last Updated:** 2026-02-15
**Generated By:** Claude Code Documentation System

---

## Overview

This document maps how data flows through the M&A Synergies Analysis Tool, from user input to database storage, processing, and output.

---

## Data Sources

### 1. **User Input (Frontend)**
- **Source:** Web browser via frontend JavaScript
- **Format:** JSON over HTTP/HTTPS
- **Entry Point:** `/frontend/src/utils/api.js`
- **Flow:**
  ```
  User Action → Frontend JS → API Call → Backend Endpoint
  ```

### 2. **PostgreSQL Database**
- **Type:** Relational database
- **Connection:** SQLAlchemy ORM
- **URI:** Configured in `backend/config.py`
  - Dev: `postgresql://localhost/synergy_tracker`
  - Test: `postgresql://localhost/synergy_tracker_test`
  - Prod: From `DATABASE_URL` environment variable

### 3. **External APIs (Future/Optional)**
- Financial data providers
- Company information APIs
- Market data feeds

---

## Data Processing Flow

### Flow 1: **User Authentication**

```
┌─────────────┐
│   Browser   │
└──────┬──────┘
       │ POST /auth/login
       │ {email, password}
       ▼
┌──────────────────────┐
│  Auth API Blueprint  │
│  (backend/api/auth.py)│
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│   UserService        │
│  - Validate password │
│  - Generate JWT      │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  UserRepository      │
│  - Query users table │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  PostgreSQL Database │
│  users table         │
└──────┬───────────────┘
       │ User record
       ▼
┌──────────────────────┐
│  JWT Token Generated │
│  Sent to Browser     │
└──────────────────────┘
```

**Data Transformations:**
1. Plain password → Hashed password (bcrypt/werkzeug)
2. User credentials → JWT token
3. Token → Authorization header

---

### Flow 2: **Synergy Creation & Analysis**

```
┌─────────────┐
│   Browser   │
└──────┬──────┘
       │ POST /api/synergies
       │ {name, type, value, companies...}
       │ Header: Authorization: Bearer <JWT>
       ▼
┌──────────────────────┐
│  Auth Middleware     │
│  - Validate JWT      │
│  - Extract user_id   │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ Synergies API        │
│ (backend/api/        │
│  synergies.py)       │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  SynergyService      │
│  - Validate input    │
│  - Calculate metrics │
│  - Check permissions │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  SynergyRepository   │
│  - Create record     │
│  - Update related    │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  PostgreSQL Database │
│  synergies table     │
│  + related tables    │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  ActivityLogger      │
│  Log creation event  │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  activity_logs table │
└──────────────────────┘
       │
       ▼
┌──────────────────────┐
│  Response JSON       │
│  → Browser           │
└──────────────────────┘
```

**Data Transformations:**
1. Frontend form data → JSON payload
2. JWT token → User identity
3. Raw values → Calculated synergy metrics
4. Business objects → Database rows (SQLAlchemy ORM)
5. Database rows → JSON response

---

### Flow 3: **Analytics Dashboard**

```
┌─────────────┐
│   Browser   │
└──────┬──────┘
       │ GET /api/analytics
       │ ?date_from=...&date_to=...
       ▼
┌──────────────────────┐
│  Analytics API       │
│  (backend/api/       │
│   analytics.py)      │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  AnalyticsService    │
│  - Parse filters     │
│  - Aggregate data    │
└──────┬───────────────┘
       │
       ├──────────────────────┐
       │                      │
       ▼                      ▼
┌──────────────────┐  ┌──────────────────┐
│ SynergyRepository│  │AnalyticsRepository│
│ - Query synergies│  │ - Query metrics  │
└──────┬───────────┘  └──────┬───────────┘
       │                      │
       ▼                      ▼
┌──────────────────────────────────────┐
│      PostgreSQL Database              │
│  - synergies table                   │
│  - companies table                   │
│  - financial_data table              │
│  - analyses table                    │
└──────┬───────────────────────────────┘
       │ Raw data
       ▼
┌──────────────────────┐
│  AnalyticsService    │
│  - Calculate KPIs    │
│  - Group by period   │
│  - Format charts     │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  Cache Layer         │
│  (Optional Redis)    │
│  - Store aggregates  │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  JSON Response       │
│  {metrics, charts}   │
│  → Browser           │
└──────────────────────┘
```

**Data Transformations:**
1. Query parameters → Filter objects
2. Database rows → Aggregated metrics
3. Raw numbers → KPIs and percentages
4. Time-series data → Chart-ready JSON

---

### Flow 4: **Report Export (PDF/Excel)**

```
┌─────────────┐
│   Browser   │
└──────┬──────┘
       │ GET /api/export/synergies?format=pdf
       ▼
┌──────────────────────┐
│  Export API          │
│  (backend/app/       │
│   routes/export.py)  │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  ExportService       │
│  - Fetch data        │
│  - Choose formatter  │
└──────┬───────────────┘
       │
       ├──────────────────────┐
       │                      │
       ▼                      ▼
┌──────────────────┐  ┌──────────────────┐
│  PDF Service     │  │ Excel Service    │
│  - Generate PDF  │  │ - Generate XLSX  │
└──────┬───────────┘  └──────┬───────────┘
       │                      │
       ▼                      ▼
┌──────────────────────────────────────┐
│  Data Queries                         │
│  - SynergyRepository                 │
│  - CompanyRepository                 │
│  - AnalyticsRepository               │
└──────┬───────────────────────────────┘
       │
       ▼
┌──────────────────────┐
│  PostgreSQL Database │
└──────┬───────────────┘
       │ Query results
       ▼
┌──────────────────────┐
│  Format Data         │
│  - Apply templates   │
│  - Add charts/images │
│  - Style output      │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  Binary File         │
│  (PDF or XLSX)       │
│  → Download          │
└──────────────────────┘
```

**Data Transformations:**
1. Database records → Formatted tables
2. Metrics → Charts/graphs
3. Structured data → PDF/Excel binary

---

### Flow 5: **Notification System**

```
┌──────────────────────┐
│  Triggering Event    │
│  - Synergy created   │
│  - Deal updated      │
│  - Workflow step     │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  Event Handler       │
│  (Service layer)     │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  NotificationService │
│  - Create notif      │
│  - Determine targets │
└──────┬───────────────┘
       │
       ├──────────────────────┐
       │                      │
       ▼                      ▼
┌──────────────────┐  ┌──────────────────┐
│ Save to Database │  │  Email Service   │
│ notifications    │  │  - Send email    │
│ table            │  │  (optional)      │
└──────────────────┘  └──────────────────┘
       │
       ▼
┌──────────────────────┐
│  User Polls          │
│  GET /api/           │
│  notifications       │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  Browser Displays    │
│  Notification Badge  │
└──────────────────────┘
```

**Data Transformations:**
1. Event → Notification object
2. Notification → Database row
3. Notification → Email message (optional)
4. Database rows → JSON list

---

### Flow 6: **Search & Filtering**

```
┌─────────────┐
│   Browser   │
└──────┬──────┘
       │ GET /api/search?q=acquisition&filters={...}
       ▼
┌──────────────────────┐
│  Search API          │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  Filter Service      │
│  - Parse query       │
│  - Build SQL filters │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  PostgreSQL Database │
│  - Full-text search  │
│    (text vectors)    │
│  - WHERE clauses     │
└──────┬───────────────┘
       │ Matching records
       ▼
┌──────────────────────┐
│  Rank & Paginate     │
│  - Order by relevance│
│  - Limit results     │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  JSON Response       │
│  {results, total,    │
│   page, per_page}    │
└──────────────────────┘
```

**Data Transformations:**
1. Search query → SQL LIKE / text search query
2. Filter JSON → SQL WHERE clauses
3. Database rows → Ranked results
4. Results → Paginated JSON

---

## Data Storage

### PostgreSQL Tables

| Table | Purpose | Key Columns | Relationships |
|-------|---------|-------------|---------------|
| **users** | User accounts | id, email, username, hashed_password, is_active, is_superuser | → companies, analyses |
| **companies** | Company profiles | id, name, ticker, industry, market_cap, owner_id | ← users, → analyses, financial_data |
| **synergies** | Synergy tracking | id, name, type, value, status, company_id | ← companies |
| **analyses** | Company analyses | id, company_id, user_id, analysis_type, summary, strengths, weaknesses | ← companies, users |
| **financial_data** | Financial metrics | id, company_id, revenue, ebitda, period | ← companies |
| **deals** | Deal management | id, name, status, value, synergies | ← synergies |
| **templates** | Reusable templates | id, name, type, content | - |
| **notifications** | User notifications | id, user_id, message, read, created_at | ← users |
| **audit_logs** | Audit trail | id, user_id, action, resource, timestamp | ← users |
| **activity_logs** | Activity tracking | id, user_id, activity_type, metadata | ← users |

---

## Data Retention & Lifecycle

1. **Active Data:**
   - All user-created records remain in database
   - No automatic deletion

2. **Audit Logs:**
   - Retained indefinitely for compliance
   - Located in `audit_logs` table

3. **Activity Logs:**
   - Retained for 90 days (configurable)
   - Can be archived/purged via admin tools

4. **Notifications:**
   - Retained for 30 days after marked as read
   - Unread notifications retained indefinitely

5. **Soft Deletes:**
   - Critical records use soft delete (is_active flag)
   - Hard deletes reserved for non-critical data

---

## Data Security

### In Transit
- HTTPS for all API communication
- JWT tokens encrypted
- Sensitive data in request body, not URL params

### At Rest
- Database credentials in environment variables
- Passwords hashed (bcrypt/werkzeug)
- No plaintext secrets in database

### Access Control
- Repository layer enforces user ownership
- JWT middleware validates all protected routes
- Role-based access (superuser privileges)

---

## Data Flow Optimization

### Caching Strategy (Optional)
```
┌──────────────────────┐
│  Request             │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  Check Redis Cache   │
└──────┬───────────────┘
       │
   ┌───┴────┐
   │ Hit?   │
   └───┬────┘
       │
  ┌────┴────┐
  │         │
  ▼         ▼
Hit       Miss
  │         │
  │         ▼
  │    ┌──────────────┐
  │    │ Query DB     │
  │    └──────┬───────┘
  │           │
  │           ▼
  │    ┌──────────────┐
  │    │ Cache Result │
  │    └──────┬───────┘
  │           │
  └───────────┘
       │
       ▼
┌──────────────────────┐
│  Return Response     │
└──────────────────────┘
```

**Cached Data:**
- Analytics aggregates (5-minute TTL)
- User session data
- Frequently accessed company profiles

---

## Data Migration Flow

```
┌──────────────────────┐
│  Code Changes        │
│  (New models/fields) │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  Alembic Migration   │
│  alembic revision    │
│  --autogenerate      │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  Review Migration    │
│  (migrations/versions)│
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  Apply Migration     │
│  alembic upgrade head│
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│  Database Schema     │
│  Updated             │
└──────────────────────┘
```

**Migration Examples:**
- `004_add_search_vector.py` - Added full-text search
- `005_add_audit_logs.py` - Added audit logging
- `add_notifications_index.py` - Performance optimization

---

## Monitoring Data Flow

### Key Metrics to Track
1. **API Response Times:**
   - Endpoint latency
   - Database query time
   - External service calls

2. **Data Volume:**
   - Records created per day
   - Database size growth
   - Cache hit/miss ratio

3. **Error Rates:**
   - Failed authentications
   - 4xx/5xx responses
   - Database connection errors

### Logging
- **Location:** `BUILD_V3.log` (for autonomous build)
- **Activity Logs:** Stored in `activity_logs` table
- **Audit Logs:** Stored in `audit_logs` table

---

## Next Steps

- Review [Architecture Diagram](./architecture.md) for system overview
- Review [API Inventory](./api-inventory.md) for endpoint details
- Set up monitoring for data flow metrics
- Consider implementing Redis cache for high-traffic endpoints

---

**Documentation Status:** ✅ Complete
**Last Verified:** 2026-02-15
